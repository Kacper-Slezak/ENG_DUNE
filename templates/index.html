<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dune: Imperium - Game Engine</title>
    <style>
        body { font-family: sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; display: flex; gap: 20px; }
        .main-column { flex: 2; }
        .sidebar-column { flex: 1; }
        .message-success { color: green; font-weight: bold; }
        .message-error { color: red; font-weight: bold; }
        fieldset { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; background: #f9f9f9; }
        legend { font-size: 1.2em; font-weight: bold; padding: 0 10px; }
        select, button { padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; cursor: pointer; }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #ccc; }
        ul { list-style: none; padding-left: 10px; }
    </style>
</head>
<body>

    <div class="main-column">
        <h1>Game Engine - Dune: Imperium (Round {{ current_round }})</h1>
        <h2>Current Phase: <span style="color: #3f51b5;">{{ current_phase }}</span></h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="message-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <hr>

        <form method="POST" action="/play_intrigue" id="intrigueForm">
            <fieldset>
                <legend>1. Play Intrigue Card (Optional)</legend>
                <input type="hidden" id="intrigue_player_name" name="player_name" value="{{ current_player }}">
                
                <p><label for="intrigue_id">Select Intrigue Card (Agent Turn only)</label>
                    <select id="intrigue_id" name="intrigue_id" required>
                        <option value="">-- Select Intrigue --</option>
                        </select>
                </p>
                <button type="submit" id="intrigueButton" disabled>Play Selected Intrigue</button>
            </fieldset>
        </form>

        <form method="POST" action="/" id="agentForm">
            <fieldset>
                <legend>2. Agent Movement</legend>
                
                <p><label for="player_name">Who is making a move? (Current: **{{ current_player }}**)</label>
                    <select id="player_name" name="player_name" required>
                        <option value="">-- Select Player --</option>
                        {% for name in player_names %}
                            {% set agent_info = player_agent_map.get(name) %}
                            <option value="{{ name }}" {% if name == current_player %}selected{% endif %}>
                                {{ name }} (Agents: {{ agent_info.placed }}/{{ agent_info.total }})
                            </option>
                        {% endfor %}
                    </select>
                </p>

                <p><label for="card_id">Which card to use? (from HAND)</label>
                    <select id="card_id" name="card_id" required>
                        <option value="">-- First select a player --</option>
                    </select>
                </p>

                <p><label for="location_id">Which location to go to? (Available)</label>
                    <select id="location_id" name="location_id" required>
                        <option value="">-- Select Location --</option>
                        {% for location in locations %}
                            <option value="{{ location.id }}">{{ location.name }}</option>
                        {% endfor %}
                    </select>
                </p>

                <button type="submit" id="agentMoveButton" disabled>Save Agent Move</button>
            </fieldset>
        </form>
        
        <hr>
        
        <h2>Game Management</h2>
        <div style="display: flex; gap: 10px;">
            <fieldset style="flex: 1;">
                <legend>AI Assistant for **{{ ai_player_name }}**</legend>
                <p><a href="{{ url_for('ai_prompt') }}" target="_blank"><button style="background-color: #3f51b5;">Generate AI Prompt</button></a></p>
            </fieldset>

            <fieldset style="flex: 1;">
                <legend>End of Round</legend>
                <p><a href="{{ url_for('reset_board') }}" onclick="return confirm('Are you sure you want to reset the board and start a new round?');"><button style="background-color: #f44336;">Reset Board/New Round</button></a></p>
            </fieldset>
        </div>

    </div>
    
    <div class="sidebar-column">
        <h2>Move History</h2>
        {% if round_history %}
            <ul>
                {% for move in round_history %}
                    <li>{{ move.summary }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>(No moves this round)</p>
        {% endif %}
    </div>
    
    
    <script>
        // --- Bezpieczne wczytanie danych z Flaska ---
        const playerCardMap = {{ player_card_map | tojson }};
        const playerAgentMap = {{ player_agent_map | tojson }};
        const playerIntrigueMap = {{ player_intrigue_map | tojson }};
        const currentPhase = {{ current_phase | tojson }};
        const currentPlayer = {{ current_player | tojson }};

        // --- Elementy DOM ---
        const playerDropdown = document.getElementById('player_name');
        const cardDropdown = document.getElementById('card_id');
        const agentMoveButton = document.getElementById('agentMoveButton');
        
        const intriguePlayerInput = document.getElementById('intrigue_player_name');
        const intrigueDropdown = document.getElementById('intrigue_id');
        const intrigueButton = document.getElementById('intrigueButton');

        // --- Funkcja aktualizująca karty Agenta (z ręki) ---
        function updateCardOptions() {
            const selectedPlayer = playerDropdown.value;
            const cardsForPlayer = playerCardMap[selectedPlayer] || [];
            
            cardDropdown.innerHTML = '';
            let defaultOption = document.createElement('option');
            defaultOption.value = "";
            
            if (selectedPlayer === "") {
                defaultOption.textContent = "-- First select a player --";
            } else if (cardsForPlayer.length === 0) {
                defaultOption.textContent = "-- No cards in hand --";
            } else {
                defaultOption.textContent = "-- Select Card from Hand --";
            }
            cardDropdown.appendChild(defaultOption);
            
            cardsForPlayer.forEach(function(card) {
                let option = document.createElement('option');
                option.value = card.id;
                option.textContent = card.name;
                cardDropdown.appendChild(option);
            });
        }
        
        // --- Funkcja aktualizująca karty Intryg (NOWOŚĆ) ---
        function updateIntrigueOptions() {
            // Używamy 'currentPlayer', ponieważ tylko aktywny gracz może grać intrygi
            intriguePlayerInput.value = currentPlayer; 
            const intriguesForPlayer = playerIntrigueMap[currentPlayer] || [];
            
            intrigueDropdown.innerHTML = '';
            let defaultOption = document.createElement('option');
            defaultOption.value = "";

            if (intriguesForPlayer.length === 0) {
                defaultOption.textContent = "-- No 'Agent Turn' intrigues --";
                intrigueButton.disabled = true;
            } else {
                defaultOption.textContent = "-- Select Intrigue --";
                intrigueButton.disabled = false; // Włącz przycisk, jeśli są karty
            }
            intrigueDropdown.appendChild(defaultOption);

            intriguesForPlayer.forEach(function(intrigue) {
                let option = document.createElement('option');
                option.value = intrigue.id;
                option.textContent = `${intrigue.name}: ${intrigue.description}`;
                intrigueDropdown.appendChild(option);
            });
        }

        // --- Funkcja sprawdzająca stan gry (NOWOŚĆ) ---
        function checkGameState() {
            const selectedPlayer = playerDropdown.value;
            const agentInfo = playerAgentMap[selectedPlayer];
            
            let canPlayAgent = false;
            if (currentPhase === 'AGENT_TURN' && agentInfo) {
                if (agentInfo.placed < agentInfo.total) {
                    canPlayAgent = true;
                }
            }
            
            // Zablokuj/Odblokuj przycisk ruchu agenta
            agentMoveButton.disabled = !canPlayAgent;
            if (!canPlayAgent) {
                agentMoveButton.textContent = (currentPhase !== 'AGENT_TURN') ? 'Not in Agent Phase' : 'No Agents Left';
            } else {
                agentMoveButton.textContent = 'Save Agent Move';
            }
            
            // Zablokuj/Odblokuj przycisk intrygi
            intrigueButton.disabled = (currentPhase !== 'AGENT_TURN' || intrigueDropdown.options.length <= 1);
        }

        // --- Event Listeners ---
        playerDropdown.addEventListener('change', () => {
            updateCardOptions();
            checkGameState();
        });
    
        // --- Inicjalizacja strony ---
        function initializePage() {
            updateCardOptions();
            updateIntrigueOptions(); // Wypełnij listę intryg
            checkGameState(); // Sprawdź, czy przyciski powinny być aktywne
        }
        
        initializePage();
        
    </script>
    
</body>
</html>