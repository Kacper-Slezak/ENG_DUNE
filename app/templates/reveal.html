<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dune: Imperium - Reveal Phase</title>
    <style>
        body { font-family: sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; display: flex; gap: 20px; }
        .main-column { flex: 2; }
        .sidebar-column { flex: 1; }
        h1, h2 { text-align: center; color: #3f51b5; }
        .player-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .player-card { border: 1px solid #ccc; padding: 15px; background: #f9f9f9; border-radius: 8px; }
        .player-card h3 { margin-top: 0; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        ul { list-style: none; padding-left: 10px; }
        li { margin-bottom: 5px; }
        .stats { font-size: 1.2em; font-weight: bold; margin-top: 10px; }
        .persuasion { color: #00897b; }
        .swords { color: #d81b60; }
        .vp { color: #F57C00; }
        .influence { font-size: 0.9em; color: #555; }
        .management { text-align: center; margin-top: 30px; }
        button { background-color: #4CAF50; color: white; cursor: pointer; padding: 10px 15px; font-size: 1em; border: none; border-radius: 5px; }
        button:hover { background-color: #45a049; }
        fieldset { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; background: #f9f9f9; }
        legend { font-size: 1.2em; font-weight: bold; padding: 0 10px; }
        select, input { padding: 8px; margin: 5px; box-sizing: border-box; width: calc(100% - 10px); }
        .message-success { color: green; font-weight: bold; }
        .message-error { color: red; font-weight: bold; }
        .conflict-display { background: #fffde7; border: 1px solid #fff59d; padding: 15px; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="main-column">
        <h1>Reveal Phase (Round {{ current_round }})</h1>
        <h2>All agents placed. Revealing cards and buying...</h2>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="message-{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="player-grid">
            {% for player_stats in all_player_stats | sort(attribute='total_swords', reverse=true) %}
            <div class="player-card">
                <h3>{{ player_stats.name }}</h3>
                
                <div class="stats">
                    <span class="vp">Victory Points: {{ player_stats.vp }}</span><br>
                    <span class="persuasion">Total Persuasion (from hand): {{ player_stats.total_persuasion }}</span><br>
                    <span class="swords">Base Swords (Cards + Troops): {{ player_stats.base_swords }}</span><br>
                    <span class="swords" style="color: #c00000;">+ Bonus Swords (Intrigue): {{ player_stats.bonus_swords }}</span><br>
                    <span class="swords" style="font-weight: bold; border-top: 1px solid #d81b60;">
                        Total Swords: {{ player_stats.base_swords + player_stats.bonus_swords }}
                    </span>
                </div>
                
                <div class="influence">
                    <hr>
                    **Influence:**
                    Emperor: {{ player_stats.influence.emperor | default(0) }} |
                    Guild: {{ player_stats.influence.guild | default(0) }} |
                    Fremen: {{ player_stats.influence.fremen | default(0) }} |
                    B.G.: {{ player_stats.influence.bene_gesserit | default(0) }}
                </div>
                <hr>

                <h4>Cards Played (Contributing Swords):</h4>
                <ul>
                    {% for card in player_stats.cards_played %}
                        <li>{{ card.name }} ({{ card.swords }}S)</li>
                    {% else %}
                        <li>(No cards played)</li>
                    {% endfor %}
                </ul>
                
                <h4>Cards in Hand (Contributing Persuasion & Swords):</h4>
                <ul>
                    {% for card in player_stats.cards_in_hand %}
                        <li>{{ card.name }} ({{ card.persuasion }}P, {{ card.swords }}S)</li>
                    {% else %}
                        <li>(No cards in hand)</li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>

        <hr>
        
        <div style="display: flex; gap: 20px;">
            <fieldset style="flex: 2;">
                <legend>Market (Imperium Row)</legend>
                <form method="POST" action="{{ url_for('buy_card') }}">
                    <p>
                        <label for="player_name">Who is buying?</label>
                        <select id="player_name" name="player_name" required>
                            <option value="">-- Select Player --</option>
                            {% for name in player_names %}
                                <option value="{{ name }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </p>
                    <p>
                        <label for="card_id">Which card to buy?</label>
                        <select id="card_id" name="card_id" required>
                             <option value="">-- Select Card --</option>
                            {% for card in market_cards %}
                                <option value="{{ card.id }}">{{ card.name }} (Cost: {{ card.cost }})</option>
                            {% else %}
                                <option value="" disabled>(Market is empty)</option>
                            {% endfor %}
                        </select>
                    </p>
                    <button type="submit" style="background-color: #00897b;">Buy Card</button>
                </form>
            </fieldset>
            </fieldset>
    </div>

    <fieldset style="border-color: #3f51b5;">
        <legend style="color: #3f51b5; font-weight: bold;">1.5 Play Battle Intrigue</legend>
        <form method="POST" action="{{ url_for('play_intrigue') }}" id="intrigueForm">

            <p><label for="intrigue_player_name">Select Player</label>
                <select id="intrigue_player_name" name="player_name" required>
                    <option value="">-- Select Player --</option>
                    {% for name in player_names %}
                        <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </p>

            <p><label for="intrigue_id">Select 'Fight' Intrigue Card (from Player's Hand)</label>
                <select id="intrigue_id" name="intrigue_id" required>
                    <option value="">-- First select a player --</option>
                </select>
            </p>
            <button type="submit" id="intrigueButton" style="background-color: #3f51b5;" disabled>Play Intrigue</button>
        </form>
    </fieldset>
    <div style="display: flex; gap: 20px; margin-top: 20px;">
        <fieldset style="flex: 1; border-color: #d81b60;">
            
            <fieldset style="flex: 1;">
                <legend>Replenish Market (Manual)</legend>
                <form method="POST" action="{{ url_for('add_to_market') }}">
                    <label for="card_id_typed">Find Card (by Name or ID):</label>
                    <input list="all_cards_list" id="card_id_typed" name="card_id_typed" placeholder="Type card name or ID..." required>
                    
                    <datalist id="all_cards_list">
                        {% for card in all_buyable_cards %}
                            <option value="{{ card.name }}">{{ card.id }}</option>
                        {% endfor %}
                    </datalist>
                    
                    <button type="submit" style="background-color: #757575; margin-top: 10px;">Add to Market</button>
                </form>
                            </fieldset>
                        </div>
                        
                        <div style="display: flex; gap: 20px; margin-top: 20px;">
                            <fieldset style="flex: 1; border-color: #d81b60;">
                    <legend style="color: #d81b60; font-weight: bold;">1. Resolve Conflict (Auto-Rewards)</legend>
                    
                    <div class="conflict-display">
                        <strong>Conflict: {{ current_conflict.name }}</strong>
                        <ul>
                            {% for reward in current_conflict.rewards_text %}
                                <li>{{ reward }}</li>
                            {% else %}
                                <li>(No conflict rewards set)</li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <form method="POST" action="{{ url_for('resolve_conflict_auto') }}">
                        <p>Naciśnij przycisk, aby automatycznie obliczyć wyniki konfliktu na podstawie <strong>Total Swords</strong> i przyznać nagrody.</p>
                        <button type="submit" style="background-color: #d81b60; margin-top: 10px;">
                            Automatycznie Rozstrzygnij Konflikt
                        </button>
                    </form>
                </fieldset>

            <fieldset style="flex: 1; border-color: #f44336;">
                <legend style="color: #f44336; font-weight: bold;">2. End Round</legend>
                <p>After buying and resolving conflict, start the next round.</p>
                <p>This button will:
                    <ul>
                        <li>Reset the board</li>
                        <li>Increase round number</li>
                        <li>Auto-draw 5 cards for ALL players</li>
                    </ul>
                </p>
                <p>
                    <a href="{{ url_for('reset_board') }}" onclick="return confirm('Are you sure you want to reset the board and start a new round?');">
                        <button style="background-color: #f44336;">Start New Round (Cleanup)</button>
                    </a>
                </p>
            </fieldset>
            
            <fieldset style="flex: 1; border-color: #b71c1c;">
                <legend style="color: #b71c1c; font-weight: bold;">Full Game Reset</legend>
                <p>This will erase all progress and reset the game to Round 1.</p>
                <p><a href="{{ url_for('full_reset') }}" onclick="return confirm('ARE YOU ABSOLUTELY SURE?\n\nThis will delete all game progress and reset to Round 1. This cannot be undone.');">
                    <button style="background-color: #b71c1c; font-weight: bold;">!!! FULL GAME RESET !!!</button>
                </a></p>
            </fieldset>
            </div>
            
        <hr>
        <p><a href="{{ url_for('ai_prompt') }}" target="_blank"><button style="background-color: #3f51b5; width: 100%;">Generate AI Prompt (for Buying Phase)</button></a></p>
    </div>
    
    <div class="sidebar-column">
        <h2>Move History (This Round)</h2>
        {% if round_history %}
            <ul>
                {% for move in round_history %}
                    {% if move.summary %}
                        <li>{{ move.summary }}</li>
                    {% else %}
                        <li>{{ move }}</li> 
                    {% endif %}
                {% endfor %}
            </ul>
        {% else %}
            <p>(No moves or purchases this round)</p>
        {% endif %}
    </div>

<script>
    // Ten skrypt jest potrzebny do dynamicznej aktualizacji formularza intryg
    const playerIntrigueMap = {{ player_intrigue_map | tojson }};
    const aiPlayerName = {{ ai_player_name | tojson }}; 

    const playerDropdown = document.getElementById('intrigue_player_name');
    const intrigueDropdown = document.getElementById('intrigue_id');
    const intrigueButton = document.getElementById('intrigueButton');

    function updateIntrigueOptions() {
        const selectedPlayer = playerDropdown.value;
        const intriguesForPlayer = playerIntrigueMap[selectedPlayer] || [];

        intrigueDropdown.innerHTML = '';
        let defaultOption = document.createElement('option');
        defaultOption.value = "";

        if (selectedPlayer === "") {
            defaultOption.textContent = "-- First select a player --";
        } else if (intriguesForPlayer.length === 0) {
            defaultOption.textContent = "-- No 'Fight' intrigues in hand --";
        } else {
            defaultOption.textContent = "-- Select Intrigue Card --";
        }

        intrigueDropdown.appendChild(defaultOption);

        intriguesForPlayer.forEach(function(intrigue) {
            let option = document.createElement('option');
            option.value = intrigue.id;
            option.textContent = intrigue.name;
            intrigueDropdown.appendChild(option);
        });

        intrigueButton.disabled = (selectedPlayer === "" || intriguesForPlayer.length === 0);
        intrigueButton.textContent = `Play Intrigue (for ${selectedPlayer || '...'})`;
    }

    if (playerDropdown) {
        playerDropdown.addEventListener('change', updateIntrigueOptions);
        updateIntrigueOptions(); // Wywołaj przy ładowaniu strony
    }
</script>
</body>
</html>