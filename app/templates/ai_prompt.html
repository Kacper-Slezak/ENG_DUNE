<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dune: Imperium - Move Assistant</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .message-success { color: green; font-weight: bold; }
        .message-error { color: red; font-weight: bold; }
        fieldset { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; }
        legend { font-size: 1.2em; font-weight: bold; padding: 0 10px; }
        select, button { padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; cursor: pointer; }
        button:hover { background-color: #45a049; }
        ul { list-style: none; padding-left: 10px; }
    </style>
</head>
<body>
    <h1>Move Assistant - Dune: Imperium (Round {{ current_round }})</h1>
    <h2>Current Phase: <span style="color: #3f51b5;">{{ current_phase }}</span></h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <p class="message-{{ category }}">{{ message }}</p>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <hr>
    
    <h2>Move History (Current Round)</h2>
    {% if round_history %}
        <ul>
            {% for move in round_history %}
                <li>{{ move.summary }}</li>
            {% endfor %}
        </ul>
    {% else %}
        <p>(No moves this round)</p>
    {% endif %}

    <hr>
    
    <form method="POST" action="/">
        <fieldset>
            <legend>Register New Move</legend>
            
            <p><label for="player_name">Who is making a move?</label>
                <select id="player_name" name="player_name" required>
                    <option value="">-- Select Player --</option>
                    {% for name in player_names %}
                        <option value="{{ name }}" {% if name == current_player %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </p>

            <p><label for="card_id">Which card to use? (from HAND)</label>
                <select id="card_id" name="card_id" required>
                    <option value="">-- First select a player --</option>
                </select>
            </p>

            <p><label for="location_id">Which location to go to? (Available)</label>
                <select id="location_id" name="location_id" required>
                    <option value="">-- Select Location --</option>
                    {% for location in locations %}
                        <option value="{{ location.id }}">{{ location.name }}</option>
                    {% endfor %}
                </select>
            </p>

            <button type="submit" {% if current_phase != 'AGENT_TURN' %}disabled{% endif %}>
                {% if current_phase == 'AGENT_TURN' %}Save Agent Move{% else %}Not currently in Agent Phase{% endif %}
            </button>
        </fieldset>
    </form>
    
    <hr>
    
    <h2>Game Management</h2>
    
    <fieldset>
        <legend>AI Assistant for **{{ ai_player_name }}**</legend>
        <p>When it is Peter's turn, click below to generate a prompt.</p>
        <p><a href="{{ url_for('ai_prompt') }}" target="_blank"><button style="background-color: #3f51b5;">Generate AI Prompt (Open in New Tab)</button></a></p>
    </fieldset>

    <fieldset>
        <legend>End of Round</legend>
        <p>When the round ends, use the button below to free all locations and proceed to the next round.</p>
        <p><a href="{{ url_for('reset_board') }}" onclick="return confirm('Are you sure you want to reset the board and start a new round?');"><button style="background-color: #f44336;">Reset Board/New Round</button></a></p>
    </fieldset>
    
    
    <script>
        // 1. We get the card map passed from Flask.
        // We use 'tojson' to safely convert the Python dictionary to a JavaScript object.
        // THANKS TO THE CHANGE IN APP.PY, THIS MAP NOW CONTAINS CARDS FROM 'HAND' NOT 'DECK_POOL'
        const playerCardMap = {{ player_card_map | tojson }};
        
        // 2. We get the DOM elements (dropdown lists)
        const playerDropdown = document.getElementById('player_name');
        const cardDropdown = document.getElementById('card_id');
    
        // 3. We define a function that will update the card list
        function updateCardOptions() {
            // Get the currently selected player
            const selectedPlayer = playerDropdown.value;
            
            // Get the list of cards for this player from our map
            // If the player has no map (e.g., "-- Select Player --" is chosen), use an empty list
            const cardsForPlayer = playerCardMap[selectedPlayer] || [];
            
            // Clear old options from the card list
            cardDropdown.innerHTML = '';
            
            // Create and add the default first option
            let defaultOption = document.createElement('option');
            defaultOption.value = ""; // Empty value
            
            if (selectedPlayer === "") {
                defaultOption.textContent = "-- First select a player --";
            } else if (cardsForPlayer.length === 0) {
                defaultOption.textContent = "-- No cards in hand --";
            } else {
                defaultOption.textContent = "-- Select Card from Hand --";
            }
            cardDropdown.appendChild(defaultOption);
            
            // Populate the list with new cards
            cardsForPlayer.forEach(function(card) {
                let option = document.createElement('option');
                option.value = card.id;       // e.g., "dagger"
                option.textContent = card.name; // e.g., "Dagger"
                cardDropdown.appendChild(option);
            });
        }
    
        // 4. Bind the 'updateCardOptions' function to the 'change' event on the player list
        playerDropdown.addEventListener('change', updateCardOptions);
    
        // 5. Call the function once on page load,
        // to populate the card list for the player who is selected by default
        updateCardOptions();
    </script>
    
</body>
</html>